\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{latexalpha2}[2019/02/26 LaTeX-Alpha2]
\RequirePackage{graphicx}
\RequirePackage{amsmath}
\RequirePackage{etoolbox}
\RequirePackage{pdftexcmds}

\newbool{cacheresults}

\DeclareOption{local}{\gdef\platform{-local}}
\DeclareOption{cloud}{\gdef\platform{-cloud}}
\DeclareOption{cache}{\booltrue{cacheresults}}
\DeclareOption{nocache}{\boolfalse{cacheresults}}

\ExecuteOptions{local,cache}
\ProcessOptions\relax

\begingroup
    \makeatletter
    \catcode`#=12
    \catcode`&=12
    \gdef\@hashchar{#}
    \gdef\@ampchar{&}
    \makeatother
\endgroup

\def\codetempfile{wolfram_code.tmp}
\def\resulttempfile{}
\def\currcodehash{}

\newcommand{\cleancodetempfile}{\immediate\write18{rm -f \codetempfile}}
\newcommand{\unknownoption}[2]{\PackageError{latexalpha2}{Unknown option '#2' for #1}{}}

\newcommand{\executewolfram}[1]{
    \IfFileExists{\resulttempfile}{
        \ifbool{cacheresults}{\message{Using the existed output file \resulttempfile}}{\executewolframcore{#1}}
    }{
        \executewolframcore{#1}
    }
}

\newcommand{\executewolframcore}[1]{
    \def\wolframscript{wolframscript -file wolfram_code.tmp -print \ifblank{#1}{}{-format #1} \platform > \resulttempfile}
    \message{\wolframscript}
    \immediate\write18{\wolframscript}
}

\newcommand{\writecodefile}[2]{
    \message{--------------------------------}
    \message{Processing latexalpha2 input: #1}
    \message{Option: #2}
    \gdef\currcodehash{\pdfmdfivesum{#1#2}}
    \gdef\resulttempfile{latexalpha2_\currcodehash.out}
    \newwrite\tempfile
    \immediate\openout\tempfile=\codetempfile
    \immediate\write\tempfile{#1}
    \immediate\closeout\tempfile
}

\newcommand{\wolfram}[2][tex]{
    \def\currformat{#1}
    \def\texformat{tex}
    \def\textformat{text}
    \def\wolframformat{wolfram}
    \cleancodetempfile
    \writecodefile{#2}{#1}
    \ifx \currformat \texformat \executewolfram{TeXForm} \else
    \ifx \currformat \textformat \executewolfram{Text} \else
    \ifx \currformat \wolframformat \executewolfram{} \else
    \unknownoption{wolfram}{#1}
    \fi\fi\fi
    \input{\resulttempfile}
    \cleancodetempfile
}

\newcommand{\wolframalpha}[2][tex]{
    \def\currformat{#1}
    \def\textformat{text}
    \def\wolframformat{wolfram}
    \def\texformat{tex}
    \cleancodetempfile
    \writecodefile{WolframAlpha["#2","\ifx\currformat\textformat ShortAnswer\else WolframResult\fi"]}{#1}
    \ifx \currformat \textformat \executewolfram{} \else
    \ifx \currformat \wolframformat \executewolfram{} \else
    \ifx \currformat \texformat \executewolfram{TeXForm} \else
    \unknownoption{wolframalpha}{#1}
    \fi\fi\fi
    \input{\resulttempfile}
    \cleancodetempfile
}

\newcommand{\wolframgraphics}[3][pdf]{
    \def\currformat{#1}
    \def\pdfformat{pdf}
    \def\pngformat{png}
    \def\jpgformat{jpg}
    \cleancodetempfile
    \writecodefile{#2}{#1}
    \ifx \currformat \pdfformat \executewolfram{PDF} \else
    \ifx \currformat \pngformat \executewolfram{PNG} \else
    \ifx \currformat \jpgformat \executewolfram{JPEG} \else
    \unknownoption{wolframgraphics}{#1}
    \fi\fi\fi
    \message{\resulttempfile}
    \ifx \currformat \pdfformat \immediate\write18{cp\space\resulttempfile\space#3.pdf} \else
    \ifx \currformat \pngformat \immediate\write18{cp\space\resulttempfile\space#3.png} \else
    \ifx \currformat \jpgformat \immediate\write18{cp\space\resulttempfile\space#3.jpg} \else
    \unknownoption{wolframgraphics}{#1}
    \fi\fi\fi
}

\newcommand{\wolframsolve}[2]{
    \cleancodetempfile
    \makeatletter
    \writecodefile{"\@backslashchar\@backslashchar begin{flalign*}"<>StringJoin@@("\@ampchar"<>ToString[ToExpression["TeXForm"][#2]]<>"="<>ToString[ToExpression["TeXForm"][\@hashchar]]<>"\@backslashchar\@backslashchar\@backslashchar\@backslashchar"\@ampchar/@(#2/.Solve[#1, #2]))<>"\@backslashchar\@backslashchar end{flalign*}"}{#1}
    \makeatother
    \executewolfram{Text}
    \input{\resulttempfile}
    \cleancodetempfile
}

\newcommand{\wolframdsolve}[3]{
    \cleancodetempfile
    \makeatletter
    \writecodefile{"\@backslashchar\@backslashchar begin{flalign*}"<>StringJoin@@("\@ampchar"<>ToString[ToExpression["TeXForm"][#2]]<>"="<>ToString[ToExpression["TeXForm"][\@hashchar]]<>"\@backslashchar\@backslashchar\@backslashchar\@backslashchar"\@ampchar/@(#2/.DSolve[#1, #2, #3]))<>"\@backslashchar\@backslashchar end{flalign*}"}{#1}
    \makeatother
    \executewolfram{Text}
    \input{\resulttempfile}
    \cleancodetempfile
}

\AtEndDocument{
    \ifbool{cacheresults}{}{\immediate\write18{rm -f latexalpha2_*.out}}
}

\endinput
