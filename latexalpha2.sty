\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{latexalpha2}[2019/02/26 LaTeX-Alpha2]
\RequirePackage{graphicx}
\RequirePackage{amsmath}
\RequirePackage{etoolbox}

\DeclareOption{local}{\newcommand{\platform}{-local}}
\DeclareOption{cloud}{\renewcommand{\platform}{-cloud}}
\ExecuteOptions{local}
\ProcessOptions\relax

\begingroup
    \makeatletter
    \catcode`#=12
    \catcode`&=12
    \gdef\@hashchar{#}
    \gdef\@ampchar{&}
    \makeatother
\endgroup

\def\codetempfile{wolfram_code.tmp}
\def\resulttempfile{wolfram_result.tmp}

\newcommand{\cleantempfiles}{\immediate\write18{rm -f wolfram_*.tmp}}
\newcommand{\unknownoption}[2]{\PackageError{latexalpha2}{Unknown option '#2' for #1}{}}

\newcommand{\executewolfram}[2]{
    \def\resultfilename{\ifblank{#2}{\resulttempfile}{#2}}
    \immediate\write18{wolframscript -file wolfram_code.tmp -print \ifblank{#1}{}{-format #1} \platform > \resultfilename}
}

\newcommand{\writetempfile}[1]{
    \newwrite\tempfile
    \immediate\openout\tempfile=\codetempfile
    \immediate\write\tempfile{#1}
    \immediate\closeout\tempfile
}

\newcommand{\wolfram}[2][tex]{
    \def\currformat{#1}
    \def\texformat{tex}
    \def\textformat{text}
    \def\wolframformat{wolfram}
    \cleantempfiles
    \writetempfile{#2}
    \ifx \currformat \texformat \executewolfram{TeXForm}{} \else
    \ifx \currformat \textformat \executewolfram{Text}{} \else
    \ifx \currformat \wolframformat \executewolfram{}{} \else
    \unknownoption{wolfram}{#1}
    \fi\fi\fi
    \input{\resulttempfile}
    \cleantempfiles
}

\newcommand{\wolframalpha}[2][tex]{
    \def\currformat{#1}
    \def\textformat{text}
    \def\wolframformat{wolfram}
    \def\texformat{tex}
    \cleantempfiles
    \writetempfile{WolframAlpha["#2","\ifx\currformat\textformat ShortAnswer\else WolframResult\fi"]}
    \ifx \currformat \textformat \executewolfram{}{} \else
    \ifx \currformat \wolframformat \executewolfram{}{} \else
    \ifx \currformat \texformat \executewolfram{TeXForm}{} \else
    \unknownoption{wolframalpha}{#1}
    \fi\fi\fi
    \input{\resulttempfile}
    \cleantempfiles
}

\newcommand{\wolframgraphics}[3][pdf]{
    \def\currformat{#1}
    \def\pdfformat{pdf}
    \def\pngformat{png}
    \def\jpgformat{jpg}
    \cleantempfiles
    \writetempfile{#2}
    \ifx \currformat \pdfformat \executewolfram{PDF}{#3.pdf} \else
    \ifx \currformat \pngformat \executewolfram{PNG}{#3.png} \else
    \ifx \currformat \jpgformat \executewolfram{JPEG}{#3.jpg} \else
    \unknownoption{wolframgraphics}{#1}
    \fi\fi\fi
}

\newcommand{\wolframsolve}[2]{
    \cleantempfiles
    \makeatletter
    \writetempfile{"\@backslashchar\@backslashchar begin{flalign*}"<>StringJoin@@("\@ampchar"<>ToString[ToExpression["TeXForm"][#2]]<>"="<>ToString[ToExpression["TeXForm"][\@hashchar]]<>"\@backslashchar\@backslashchar\@backslashchar\@backslashchar"\@ampchar/@(#2/.Solve[#1, #2]))<>"\@backslashchar\@backslashchar end{flalign*}"}
    \makeatother
    \executewolfram{Text}{}
    \input{\resulttempfile}
    \cleantempfiles
}

\newcommand{\wolframdsolve}[3]{
    \cleantempfiles
    \makeatletter
    \writetempfile{"\@backslashchar\@backslashchar begin{flalign*}"<>StringJoin@@("\@ampchar"<>ToString[ToExpression["TeXForm"][#2]]<>"="<>ToString[ToExpression["TeXForm"][\@hashchar]]<>"\@backslashchar\@backslashchar\@backslashchar\@backslashchar"\@ampchar/@(#2/.DSolve[#1, #2, #3]))<>"\@backslashchar\@backslashchar end{flalign*}"}
    \makeatother
    \executewolfram{Text}{}
    \input{\resulttempfile}
    \cleantempfiles
}

\endinput
